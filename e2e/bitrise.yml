format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

workflows:
  test_ndk:
    summary: Test NDK compilation without specifying an NDK version in the step
    envs:
    - SAMPLE_APP_URL: https://github.com/bitrise-io/android-ndk-sample-project.git
    - BRANCH: ndk22-compatible
    - GRADLE_BUILD_FILE_PATH: ./build.gradle
    - GRADLEW_PATH: ./gradlew
    - ANDROID_NDK_HOME: ""
    before_run:
    - _setup
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            rm -rf $ANDROID_HOME/ndk-bundle
    after_run:
    - _run_and_build

  test_react_native:
    envs:
    - SAMPLE_APP_URL: https://github.com/bitrise-io/Bitrise-React-Native-Sample.git
    - BRANCH: master
    - GRADLE_BUILD_FILE_PATH: android/build.gradle
    - GRADLEW_PATH: android/gradlew
    before_run:
    - _setup
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            yarn
    - path::./:
        title: Execute step
        inputs:
          - ndk_revision: 21
    - gradle-runner:
        inputs:
        - gradle_task: assembleDebug

  test_ndk_install:
    summary: Test installing multiple NDK revisions and compare installed version numbers to expected values
    envs:
    - SAMPLE_APP_URL: https://github.com/bitrise-io/android-ndk-sample-project.git
    - BRANCH: ndk22-compatible
    - GRADLE_BUILD_FILE_PATH: build.gradle
    - GRADLEW_PATH: ./gradlew
    before_run:
    - _setup
    steps:
    - path::./:
        title: Execute step without NDK version
        inputs:
        - ndk_revision: ""
    - path::./:
        title: Execute step with NDK r18
        inputs:
        - ndk_revision: 18
    - script:
        title: Check installed NDK version
        inputs:
        - content: |-
            EXPECTED_VERSION=18.0.5002713
            NDK_VERSION=`cat $ANDROID_HOME/ndk-bundle/source.properties | grep Pkg.Revision | cut -d'=' -f2 | cut -d' ' -f2`
            if [ $NDK_VERSION != $EXPECTED_VERSION ]; then
              echo "Unexpected installed NDK version: $NDK_VERSION"
              echo "Expected: $EXPECTED_VERSION"
              exit 1
            else
              echo "NDK version is correct: $NDK_VERSION"
            fi
    - path::./:
        title: Execute step again with NDK r18
        inputs:
        - ndk_revision: 18
    - script:
        title: Check installed NDK version
        inputs:
        - content: |-
            EXPECTED_VERSION=18.0.5002713
            NDK_VERSION=`cat $ANDROID_HOME/ndk-bundle/source.properties | grep Pkg.Revision | cut -d'=' -f2 | cut -d' ' -f2`
            if [ $NDK_VERSION != $EXPECTED_VERSION ]; then
              echo "Unexpected installed NDK version: $NDK_VERSION"
              echo "Expected: $EXPECTED_VERSION"
              exit 1
            else
              echo "NDK version is correct: $NDK_VERSION"
            fi
    - path::./:
        title: Execute step with NDK r17
        inputs:
        - ndk_revision: 17
    - script:
        title: Check installed NDK version
        inputs:
        - content: |-
            EXPECTED_VERSION=17.0.4754217
            NDK_VERSION=`cat $ANDROID_HOME/ndk-bundle/source.properties | grep Pkg.Revision | cut -d'=' -f2 | cut -d' ' -f2`
            if [ $NDK_VERSION != $EXPECTED_VERSION ]; then
              echo "Unexpected installed NDK version: $NDK_VERSION"
              echo "Expected: $EXPECTED_VERSION"
              exit 1
            else
              echo "NDK version is correct: $NDK_VERSION"
            fi
    - path::./:
        title: Execute step with NDK r22
        description: NDK r22 doesn't contain the platforms dir anymore
        inputs:
        - ndk_revision: 22
    - script:
        title: Check installed NDK version
        inputs:
        - content: |-
            EXPECTED_VERSION=22.0.7026061
            NDK_VERSION=`cat $ANDROID_HOME/ndk-bundle/source.properties | grep Pkg.Revision | cut -d'=' -f2 | cut -d' ' -f2`
            if [ $NDK_VERSION != $EXPECTED_VERSION ]; then
              echo "Unexpected installed NDK version: $NDK_VERSION"
              echo "Expected: $EXPECTED_VERSION"
              exit 1
            else
              echo "NDK version is correct: $NDK_VERSION"
            fi
    - gradle-runner:
        inputs:
        - gradle_task: assembleDebug

  test_support_library:
    envs:
    - SAMPLE_APP_URL: https://github.com/bitrise-io/sample-apps-android-x.git
    - BRANCH: master
    - GRADLE_BUILD_FILE_PATH: build.gradle
    - GRADLEW_PATH: ./gradlew
    before_run:
    - _setup
    steps:
    - script:
        title: Uninstall Android SDK
        inputs:
        - content: |-
            #!/usr/bin/env bash
            sdkmanager --uninstall "extras;android;m2repository"
    after_run:
    - _run_and_build

  _setup:
    steps:
    - script:
          run_if: $.IsCI
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex
                if [[ "$OSTYPE" == "linux-gnu"* ]]; then
                  sudo update-alternatives --set javac /usr/lib/jvm/java-11-openjdk-amd64/bin/javac
                  sudo update-alternatives --set java /usr/lib/jvm/java-11-openjdk-amd64/bin/java
                  export JAVA_HOME="/usr/lib/jvm/java-11-openjdk-amd64"
                  envman add --key JAVA_HOME --value "/usr/lib/jvm/java-11-openjdk-amd64"
                elif [[ "$OSTYPE" == "darwin"* ]]; then
                  jenv global 11
                  export JAVA_HOME="$(jenv prefix)"
                  envman add --key JAVA_HOME --value "$(jenv prefix)"
                fi
    - script:
        title: Clean _tmp dir
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            rm -rf ./_tmp
    - change-workdir:
        title: Switch working dir to _tmp
        run_if: "true"
        inputs:
        - path: ./_tmp
        - is_create_path: true
    - git::https://github.com/bitrise-steplib/bitrise-step-simple-git-clone.git@master:
        title: Clone sample app
        inputs:
        - repository_url: $SAMPLE_APP_URL
        - clone_into_dir: .
        - branch: $BRANCH
  _run_and_build:
    steps:
    - path::./:
        title: Execute step
    - gradle-runner:
        inputs:
        - gradle_task: assembleDebug
